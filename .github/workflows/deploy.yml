name: Deploy

on:
  push:
    branches: [main]

permissions:
  contents: read
  id-token: write

env:
  PROJECT_ID: final-ingsoft3-2025-480515
  REGION: us-central1
  REGISTRY_HOST: us-central1-docker.pkg.dev
  REPOSITORY: cloud-run-source-deploy

jobs:
  build-userapi:
    name: Build Backend Image
    runs-on: ubuntu-latest
    env:
      PROJECT_ID: final-ingsoft3-2025-480515
      REGION: us-central1
      REGISTRY_HOST: us-central1-docker.pkg.dev
    outputs:
      image: ${{ steps.publish.outputs.image }}
    steps:
      - uses: actions/checkout@v4

      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: final-ingsoft3-2025-480515

      - name: Configure Docker auth
        run: gcloud auth configure-docker $REGISTRY_HOST

      - id: vars
        run: |
          IMAGE="${REGISTRY_HOST}/${PROJECT_ID}/${REPOSITORY}/userapi:${GITHUB_SHA}"
          echo "image=$IMAGE" >> "$GITHUB_OUTPUT"

      - name: Build backend image
        run: docker build -t ${{ steps.vars.outputs.image }} ./APIs/UserAPI

      - name: Push backend image
        run: docker push ${{ steps.vars.outputs.image }}

      - id: publish
        run: echo "image=${{ steps.vars.outputs.image }}" >> $GITHUB_OUTPUT

  deploy-qa:
    name: Deploy Backend to QA
    needs: build-userapi
    runs-on: ubuntu-latest
    environment:
      name: qa
    steps:
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - uses: google-github-actions/setup-gcloud@v2

      - name: Clear existing configuration
        run: |
          gcloud run services update userapi-qa \
            --region=us-central1 \
            --clear-env-vars \
            --clear-secrets || true

      - uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to QA
        run: |
          gcloud run deploy userapi-qa \
            --image ${{ needs.build-userapi.outputs.image }} \
            --region us-central1 \
            --platform managed \
            --allow-unauthenticated \
            --set-env-vars "ALGORITHM=HS256,ACCESS_TOKEN_EXPIRE_MINUTES=30" \
            --set-secrets "DATABASE_URL=DATABASE_URL:latest,SECRET_KEY=SECRET_KEY:latest,EMAIL_USER=EMAIL_USER:latest,EMAIL_PASSWORD=EMAIL_PASSWORD:latest,INTERNAL_SERVICE_API_KEY=INTERNAL_SERVICE_API_KEY:latest" \
            --add-cloudsql-instances=final-ingsoft3-2025-480515:us-central1:userapi-db \
            --service-account=userapi-service-account@final-ingsoft3-2025-480515.iam.gserviceaccount.com

  build-frontend-qa:
    name: Build Frontend Image (QA)
    runs-on: ubuntu-latest
    env:
      PROJECT_ID: final-ingsoft3-2025-480515
      REGION: us-central1
      REGISTRY_HOST: us-central1-docker.pkg.dev
    outputs:
      image: ${{ steps.publish.outputs.image }}
    steps:
      - uses: actions/checkout@v4

      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: final-ingsoft3-2025-480515

      - name: Configure Docker auth
        run: gcloud auth configure-docker $REGISTRY_HOST

      - id: vars
        run: |
          IMAGE="${REGISTRY_HOST}/${PROJECT_ID}/${REPOSITORY}/frontend-qa:${GITHUB_SHA}"
          echo "image=$IMAGE" >> "$GITHUB_OUTPUT"

      - name: Build frontend QA image
        run: docker build --build-arg BUILD_ENV=qa -t ${{ steps.vars.outputs.image }} ./tf-frontend

      - name: Push frontend QA image
        run: docker push ${{ steps.vars.outputs.image }}

      - id: publish
        run: echo "image=${{ steps.vars.outputs.image }}" >> $GITHUB_OUTPUT

  deploy-frontend-qa:
    name: Deploy Frontend to QA
    needs: build-frontend-qa
    runs-on: ubuntu-latest
    environment:
      name: qa
    steps:
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - uses: google-github-actions/setup-gcloud@v2

      - name: Deploy Frontend to QA
        run: |
          gcloud run deploy frontend-qa \
            --image ${{ needs.build-frontend-qa.outputs.image }} \
            --region us-central1 \
            --platform managed \
            --allow-unauthenticated

  deploy-production:
    name: Deploy Backend to Production
    needs:
      - deploy-qa
      - build-userapi
    runs-on: ubuntu-latest
    environment:
      name: production
    steps:
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - uses: google-github-actions/setup-gcloud@v2

      - name: Clear existing configuration
        run: |
          gcloud run services update userapi \
            --region=us-central1 \
            --clear-env-vars \
            --clear-secrets || true

      - uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to Production
        run: |
          gcloud run deploy userapi \
            --image ${{ needs.build-userapi.outputs.image }} \
            --region us-central1 \
            --platform managed \
            --allow-unauthenticated \
            --set-env-vars "ALGORITHM=HS256,ACCESS_TOKEN_EXPIRE_MINUTES=120" \
            --set-secrets "DATABASE_URL=DATABASE_URL:latest,SECRET_KEY=SECRET_KEY:latest,EMAIL_USER=EMAIL_USER:latest,EMAIL_PASSWORD=EMAIL_PASSWORD:latest,INTERNAL_SERVICE_API_KEY=INTERNAL_SERVICE_API_KEY:latest" \
            --add-cloudsql-instances=final-ingsoft3-2025-480515:us-central1:userapi-db \
            --service-account=userapi-service-account@final-ingsoft3-2025-480515.iam.gserviceaccount.com

  build-frontend-prod:
    name: Build Frontend Image (Prod)
    needs: deploy-production
    runs-on: ubuntu-latest
    env:
      PROJECT_ID: final-ingsoft3-2025-480515
      REGION: us-central1
      REGISTRY_HOST: us-central1-docker.pkg.dev
    outputs:
      image: ${{ steps.publish.outputs.image }}
    steps:
      - uses: actions/checkout@v4

      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: final-ingsoft3-2025-480515

      - name: Configure Docker auth
        run: gcloud auth configure-docker $REGISTRY_HOST

      - id: vars
        run: |
          IMAGE="${REGISTRY_HOST}/${PROJECT_ID}/${REPOSITORY}/frontend-prod:${GITHUB_SHA}"
          echo "image=$IMAGE" >> "$GITHUB_OUTPUT"

      - name: Build frontend production image
        run: docker build --build-arg BUILD_ENV=production -t ${{ steps.vars.outputs.image }} ./tf-frontend

      - name: Push frontend production image
        run: docker push ${{ steps.vars.outputs.image }}

      - id: publish
        run: echo "image=${{ steps.vars.outputs.image }}" >> $GITHUB_OUTPUT

  deploy-frontend-prod:
    name: Deploy Frontend to Production
    needs: build-frontend-prod
    runs-on: ubuntu-latest
    environment:
      name: production
    steps:
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - uses: google-github-actions/setup-gcloud@v2

      - name: Deploy Frontend to Production
        run: |
          gcloud run deploy frontend \
            --image ${{ needs.build-frontend-prod.outputs.image }} \
            --region us-central1 \
            --platform managed \
            --allow-unauthenticated
